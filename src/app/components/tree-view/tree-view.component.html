<div class="tree-container">
  <!-- Loading indicator -->
  <div *ngIf="loading$ | async" class="loading-overlay">
    <mat-spinner [diameter]="40"></mat-spinner>
  </div>

  <!-- Error message -->
  <div *ngIf="error$ | async as error" class="error-message">
    <mat-icon>error</mat-icon>
    <span>{{ error }}</span>
  </div>

  <!-- Virtual scrolling tree -->
  <cdk-virtual-scroll-viewport
    [itemSize]="itemSize"
    class="tree-viewport">
    <div
      *cdkVirtualFor="let node of flatNodes$; trackBy: trackByNodeId"
      class="tree-node"
      [class.selected]="(selectedNodeId$ | async) === node.id"
      [class.business-object]="node.entityType === EntityType.BusinessObject"
      [class.profile]="node.entityType === EntityType.Profile"
      [class.entity]="node.entityType === EntityType.Entity"
      [style.padding-left.px]="node.level * 20"
      (click)="selectNode(node)"
      (contextmenu)="onContextMenu($event, node)">

      <!-- Expand/collapse button -->
      <button
        mat-icon-button
        class="expand-button"
        *ngIf="node.hasChildren"
        (click)="toggleNode(node, $event)">
        <mat-spinner
          *ngIf="node.isLoading"
          [diameter]="20"
          class="loading-spinner">
        </mat-spinner>
        <mat-icon *ngIf="!node.isLoading">{{ getExpandIcon(node) }}</mat-icon>
      </button>

      <!-- Empty space for alignment when no children -->
      <span *ngIf="!node.hasChildren" class="no-expand-spacer"></span>

      <!-- Node icon -->
      <mat-icon class="node-icon">{{ getNodeIcon(node) }}</mat-icon>

      <!-- Node label -->
      <span class="node-label">{{ node.name }}</span>

      <!-- Child count badge -->
      <span *ngIf="node.hasChildren" class="child-count">{{ node.childCount }}</span>
    </div>
  </cdk-virtual-scroll-viewport>
</div>
